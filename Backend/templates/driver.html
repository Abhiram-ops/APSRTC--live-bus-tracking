<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - APSRTC Live</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <div class="container mt-4 mb-5" style="max-width: 500px;">
        <div class="card-box">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="m-0 card-title"><i class="bi bi-person-badge-fill"></i> Driver</h3>
                <div>
                    <span class="badge bg-secondary me-2">{{ username }}</span>
                    <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold small text-muted">SELECT SERVICE NUMBER</label>
                <select id="serviceSelect" class="form-select form-select-lg">
                    <option value="28A">28A (Gajuwaka - Beach Road)</option>
                    <option value="6K">6K (Maddilapalem - Simhachalam)</option>
                    <option value="400K">400K (RTC Complex - Railway Stn)</option>
                </select>
            </div>

            <div class="d-grid gap-3">
                <button id="startBtn" class="btn btn-success btn-lg shadow-sm">
                    <i class="bi bi-broadcast"></i> Start Sharing
                </button>
                <button id="stopBtn" class="btn btn-secondary btn-lg" disabled>
                    <i class="bi bi-stop-circle"></i> Stop Sharing
                </button>
            </div>

            <!-- Status Indicator -->
            <div id="statusContainer" class="mt-4 p-3 rounded-3 text-center bg-light">
                <div class="small text-muted mb-1">STATUS</div>
                <div class="fw-bold fs-5 status-text">Inactive ‚ö™</div>
            </div>

            <div id="debugLog" class="mt-3 small text-muted font-monospace"
                style="height: 100px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 8px;">
                Logs will appear here...
            </div>
        </div>
    </div>

    <script>
        let watchId = null;
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const serviceSelect = document.getElementById("serviceSelect");
        const statusBox = document.getElementById("statusBox");
        const statusContainer = document.getElementById("statusContainer");
        const debugLog = document.getElementById("debugLog");

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement("div");
            div.innerHTML = `<span style="color:#888;">[${time}]</span> ${msg}`;
            debugLog.insertBefore(div, debugLog.firstChild);
            // Limit logs
            if (debugLog.children.length > 50) debugLog.removeChild(debugLog.lastChild);
        }

        startBtn.addEventListener("click", () => {
            const serviceNo = serviceSelect.value;
            if (!serviceNo) {
                alert("Please select a service number first.");
                return;
            }

            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            // UI Updates - Active State
            startBtn.style.display = "none";
            stopBtn.style.display = "block";
            serviceSelect.disabled = true;

            statusContainer.classList.add("status-active", "pulse");
            statusContainer.classList.remove("status-error");
            statusBox.querySelector(".status-text").innerHTML = `Connecting GPS... üõ∞Ô∏è`;

            log("Requesting GPS access...");

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            // Success Callback
            const onLocationSuccess = (pos) => {
                const { latitude, longitude, speed } = pos.coords;
                // speed is in m/s, convert to km/h, default to 0 if null
                const speedKmph = speed ? (speed * 3.6).toFixed(1) : 0;

                updateBackend(serviceNo, latitude, longitude, speedKmph);

                statusBox.querySelector(".status-text").innerHTML = `Live üü¢ <br><small>Sharing for ${serviceNo}</small>`;
                statusContainer.classList.add("status-active", "pulse");
                statusContainer.classList.remove("status-error");
            };

            // Error Callback
            const onLocationError = (err) => {
                console.error(err);
                log("‚ö†Ô∏è GPS Error (" + err.code + "): " + err.message);

                if (err.code === 1) {
                    alert("Please allow Location Access to share live tracking.");
                } else if (err.code === 3) {
                    log("‚ö†Ô∏è High accuracy timed out. Trying low accuracy...");
                    // Fallback to low accuracy
                    navigator.geolocation.getCurrentPosition(
                        onLocationSuccess,
                        (e) => {
                            log("‚ùå Low accuracy failed too: " + e.message);
                            statusBox.querySelector(".status-text").innerHTML = "GPS Failed üî¥";
                            statusContainer.classList.add("status-error");
                        },
                        { enableHighAccuracy: false, timeout: 15000 }
                    );
                    return; // Don't stop, try fallback
                }

                statusContainer.classList.remove("status-active", "pulse");
                statusContainer.classList.add("status-error");
                statusBox.querySelector(".status-text").innerHTML = "GPS Error üî¥";
            };

            // Force immediate update
            navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, options);

            // Start Watching
            watchId = navigator.geolocation.watchPosition(onLocationSuccess, onLocationError, options);
        });

        stopBtn.addEventListener("click", () => {
            stopTracking();
        });

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            // UI Reset
            stopBtn.style.display = "none";
            startBtn.style.display = "block";
            serviceSelect.disabled = false;

            statusContainer.classList.remove("status-active", "pulse", "status-error");
            statusBox.querySelector(".status-text").innerHTML = "Offline ‚ö™";

            log("Stopped tracking.");
        }

        async function updateBackend(serviceNo, lat, lng, speed) {
            try {
                /* 
                   In a real deployment with separate frontend/backend domains, 
                   use the full URL. Here relative path works. 
                */
                const response = await fetch('/api/update_location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_no: serviceNo,
                        lat: lat,
                        lng: lng,
                        speed: speed
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Sent: ${lat.toFixed(5)}, ${lng.toFixed(5)} (${speed} km/h)`);
                } else {
                    let errorMessage = "Status " + response.status;
                    try {
                        const errData = await response.json();
                        if (errData.error) errorMessage = errData.error;
                    } catch (e) {
                        const text = await response.text();
                        if (text) errorMessage += " " + text.substring(0, 100);
                    }

                    log("‚ùå Error: " + errorMessage);
                    console.error("Backend Error:", errorMessage);

                    statusContainer.classList.remove("status-active", "pulse");
                    statusContainer.classList.add("status-error");
                    statusBox.querySelector(".status-text").innerHTML = "Error üî¥";
                }
            } catch (err) {
                log("‚ùå Network Error: " + err.message);
            }
        }
        async function logout() {
            try {
                await fetch("/api/driver/logout", { method: "POST" });
                window.location.reload();
            } catch (e) { window.location.reload(); }
        }
    </script>
</body>

</html>